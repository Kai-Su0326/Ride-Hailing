var map,crd,myLoc,markers=[];function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:{lat:42.401251,lng:-71.110237},zoom:14})}function success(e){crd=e.coords;for(var n=new google.maps.Marker({position:{lat:crd.latitude,lng:crd.longitude},map:map,title:"me"}),t=0;t<markers.length;t++)markers[t].setMap(null);markers=[],fireRequest(crd,n),myLoc=n}function fireRequest(e,n){var t=`_id=a1&username=Me&lat=${e.latitude}&lng=${e.longitude}`,a=new XMLHttpRequest;a.open("POST","https://serene-caverns-36515.herokuapp.com/rides",!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.onload=function(){var t=calDist(this.responseText,e);windowInit(n,t),drawLine(t,e)},a.send(t)}function calDist(e,n){var t=JSON.parse(e),a=[];return t.forEach(function(e){var t=new google.maps.LatLng(n.latitude,n.longitude),o=new google.maps.LatLng(Number(e.lat),Number(e.lng)),r=google.maps.geometry.spherical.computeDistanceBetween(t,o);a.push([e.username,r/1609,Number(e.lat),Number(e.lng)]),markers.push(markCar(e,r/1609))}),0===a.length?(alert("No car around you!"),null):(a.sort(function(e,n){return e[1]-n[1]}),a[0])}function markCar(e,n){var t={url:"style/car.png",scaledSize:new google.maps.Size(15,35)},a=new google.maps.Marker({position:{lat:Number(e.lat),lng:Number(e.lng)},map:map,icon:t,title:e.username}),o=`This vehicle is ${n} miles away from you. `,r=new google.maps.InfoWindow({content:o});return a.addListener("click",function(){r.open(map,a)}),a}function windowInit(e,n){if(null!=n){var t=`The closest vehicle belongs to ${n[0]}. It is ${n[1]} miles away from you.`,a=new google.maps.InfoWindow({content:t});e.addListener("click",function(){a.open(map,e)})}}function drawLine(e,n){if(null!=e){var t=[{lat:e[2],lng:e[3]},{lat:n.latitude,lng:n.longitude}];new google.maps.Polyline({path:t,geodesic:!0,strokeColor:"#324aa8",strokeOpacity:.7,strokeWeight:3}).setMap(map)}}const driverSub=e=>{e.preventDefault();var n=`username=${document.getElementById("dusername").value}&lat=${document.getElementById("dlat").value}&lng=${document.getElementById("dlng").value}`,t=new XMLHttpRequest;t.open("PUT","https://serene-caverns-36515.herokuapp.com/vehicle",!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onload=function(){navigator.geolocation.getCurrentPosition(success)},t.send(n)},passengerSub=e=>{e.preventDefault();var n=document.getElementById("pusername").value,t=document.getElementById("plat").value,a=document.getElementById("plng").value,o=`username=${n}&lat=${t}&lng=${a}`,r=new XMLHttpRequest;r.open("PUT","https://serene-caverns-36515.herokuapp.com/passenger",!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onload=function(){new google.maps.Marker({position:{lat:Number(t),lng:Number(a)},map:map,title:n})},r.send(o)};window.addEventListener("load",initMap,!1),navigator.geolocation.getCurrentPosition(success),document.getElementById("dbtn").addEventListener("click",driverSub),document.getElementById("pbtn").addEventListener("click",passengerSub),window.addEventListener("beforeunload",function(e){e.preventDefault(),myLoc.setMap(null)});